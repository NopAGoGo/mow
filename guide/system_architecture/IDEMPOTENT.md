# 幂等

## 什么是幂等（定义）

在数学里，幂等有两种主要的定义。

1. 在某**二元运算**下，幂等元素是指被自己重复运算(或对于函数是为复合)的结果等于它自己的元素。

    例如，乘法下仅有两个幂等实数，为0和1。

    设S为一具有作用于其自身的二元运算的集合，则S的元素s称为幂等的(相对于*)当

    s *s = s.

    特别的是，任一单位元都是幂等的。若S的所有元素都是幂等的话，则其二元运算*被称做是幂等的。

    例如，联集和交集的运算便都是幂等的。

2. 某一元运算为幂等的时，其作用在任一元素两次后会和其作用一次的结果相同。

    例如，高斯符号便是幂等的。

    一元运算的定义是二元运算定义的特例

    设f为一由X映射至X的一元运算，则f为幂等的，当对于所有在X内的x，

    f(f(x)) = f(x).

    特别的是，恒等函数一定是幂等的，且任一常数函数也都是幂等的。

    注意当考虑一由X至X的所有函数所组成的集合S时。在f在一元运算下为幂等的若且唯若在二元运算下，f相对于其复合运算(标记为o)会是幂等的。这可以写成f o f = f。

## 特点

幂等(idempotent)操作的特点：任意多次执行所产生的影响均与一次执行的影响相同。

幂等函数，或幂等方法，是指可以使用相同参数重复执行，并能获得相同结果的函数。这些函数不会影响系统状态，也不用担心重复执行会对系统造成改变。

## 例子

1. 比如前端对同一表单数据的重复提交，后台应该只会产生一个结果。

1. 比如我们发起一笔付款请求，应该只扣用户账户一次钱，当遇到网络重发或系统bug重发，也应该只扣一次钱。

1. 查询一次和查询多次，在数据不变的情况下，查询结果是一样的，select是天然的幂等操作。

1. 删除操作也是幂等的，删除同一个多次效果一样。

1. update直接更新某个值的,幂等

1. update更新累加操作的,非幂等

1. insert非幂等操作,每次新增一条

## 实现幂等性的技术方案

1. 唯一索引，防止新增脏数据

    拿资金账户和用户账户来说，每个用户只能有一个资金账户，怎么防止给用户创建资金账户多个，那么给资金账户表中的用户ID加唯一索引，在新增的时候只有一个请求成功，剩下都会抛出唯一索引重复异常。比如`org.springframework.dao.DuplicateKeyException`，这时候再查询一次就可以了，数据存在，返回结果。

1. token机制，防止页面重复提交

    数据提交前要向服务的申请token，token放到redis或jvm内存，token有效时间

    提交后后台校验token，同时删除token，生成新的token返回

    token特点：要申请，一次有效性，可以限流。

    存在并发问题，不建议使用

1. 悲观锁

    获取数据的时候加锁获取 select * from table_xxx where id=’xxx’ for update;  

    注意：id字段一定是主键或者唯一索引，不然是锁表，会出事的。悲观锁使用时一般伴随事务一起使用，数据锁定时间可能会很长，根据实际情况选用。

1. 乐观锁

    乐观锁只是在更新数据那一刻锁表，其他时间不锁表，所以相对于悲观锁，效率更高。乐观锁的实现方式多种多样可以通过version或者其他状态条件：

    1. 通过版本号实现 update table_xxx set name=#name#,version=version+1 where version=#version#  

    2. 通过条件限制 update table_xxx set avai_amount=avai_amount-#subAmount# where avai_amount-#subAmount# >= 0

    注意：乐观锁的更新操作，最好用主键或者唯一索引来更新，这样是行锁，否则更新时会锁表，上面两个sql改成下面的两个更好。

    update table_xxx set name=#name#,version=version+1 where id=#id# and version=#version#

    update table_xxx set avai_amount=avai_amount-#subAmount# where id=#id# and avai_amount-#subAmount# >= 0

1. 分布式锁

    通过第三方的系统(redis或zookeeper)，在业务系统插入数据或者更新数据，获取分布式锁，然后做操作，之后释放锁，其实就是为了控制多线程并发的操作，也是分布式系统中经常用到的解决思路。

1. select + insert

    并发不高的后台系统，或者一些任务JOB，为了支持幂等，支持重复执行，简单的处理方法是，先查询下一些关键数据，判断是否已经执行过，在进行业务处理，就可以了。

    注意：核心高并发流程不要用这种方法。

1. 状态机幂等

    在设计单据相关的业务，或者是任务相关的业务，肯定会涉及到状态机(状态变更图)，就是业务单据上面有个状态，状态在不同的情况下会发生变更，一般情况下存在有限状态机，这时候，如果状态机已经处于下一个状态，这时候来了一个上一个状态的变更，理论上是不能够变更的，这样的话，保证了有限状态机的幂等。注意：订单等单据类业务，存在很长的状态流转，一定要深刻理解状态机，对业务系统设计能力提高有很大帮助。

    注意：订单等单据类业务，存在很长的状态流转，一定要深刻理解状态机，对业务系统设计能力提高有很大帮助。

### 对外提供接口的api如何保证幂等

    如银联提供的付款接口：需要接入商户提交付款请求时附带：source来源，seq序列号，source+seq在数据库里面做唯一索引，防止多次付款，(并发时，只能处理一个请求)。

    注意，为了幂等友好，一定要先查询一下，是否处理过该笔业务，不查询直接插入业务系统，会报错，但实际已经处理了。

## 最后总结

幂等性应该是合格程序员的一个基因，在设计系统时，是首要考虑的问题，尤其是在像第三方支付平台，银行，互联网金融公司等涉及的网上资金系统，既要高效，数据也要准确，所以不能出现多扣款，多打款等问题，这样会很难处理，并会大大降低用户体验。
